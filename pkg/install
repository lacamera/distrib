#!/bin/sh
self=${0##*/}
prefix="$(dirname `realpath $0`)"
uid=`id -u`
uname=`uname`

[[ $uid -ne 0 ]]\
  && { printf "%s needs id=0 to proceed, got id=%s.\n" $self $uid; exit 1; }
[[ $uname -eq OpenBSD ]] && [[ -z $DOAS_USER ]]\
  && { printf "DOAS_USER not set.\n"; exit 1; }

while getopts "n" opt; do
  case $opt in
  n) PRINT_ONLY=1;;
  *) echo "usage: pkg/$self [-n]"
    exit 1
  esac
done

case $uname in
OpenBSD)
  [[ -n $PRINT_ONLY ]] && list=obsd-full.list || list=obsd.list
  py3pip="python3 -m pip install --user --upgrade -r $prefix/pip.list"
  vimplug="curl -fLo ${XDG_DATA_HOME:-$HOME/.local/share}/nvim/site/autoload/plug.vim\
    --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim;\
    nvim +PlugClean! +PlugInstall! +qall!"
  user_cmd="su $DOAS_USER -c '$py3pip; $vimplug'"
  cmd="pkg_add -IUl $prefix/$list"

  [[ -n $PRINT_ONLY ]]\
    && { printf "$cmd\n$user_cmd\n"; }\
    || { eval $cmd; eval $user_cmd; };;
*) printf "Unsupported platform: %s.\n" $uname; exit 1;;
esac
