#!/bin/sh
set -e
self=${0##*/}
prefix=$(dirname `realpath $0`)
uid=`id -u`
uname=`uname`

if [[ $uid -ne 0 ]]; then
	echo "$self needs id=0 to proceed, got id=$uid."
	exit 1
fi

usage() {
	echo "usage: pkg/$self [-n]"
	exit 1
}

while getopts "n" opt; do
	case $opt in
	  n) PRINT_ONLY=1;;
	  *) usage;;
	esac
done

case $uname in
	OpenBSD) 
		[[ -n $PRINT_ONLY ]]\
			|| pkg_add -IUl $prefix/obsd.list\
			&& echo "pkg_add -IUl $prefix/obsd.list"
		if [[ -z $DOAS_USER ]]; then
			echo "DOAS_USER needs to be set to install user packages."
			exit 1
		fi
		if [[ -n $PRINT_ONLY ]]; then
		  echo "su $DOAS_USER -c \"python3 -m pip install --user --upgrade -r $prefix/pip.list\""
		  echo "su $DOAS_USER -c \"sh -c 'curl -fLo ${XDG_DATA_HOME:-$HOME/.local/share}/nvim/site/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'\""
		  echo "su $DOAS_USER -c \"nvim +PlugClean! +PlugInstall! +qall!\""
		else
		  su $DOAS_USER -c "python3 -m pip install --user --upgrade -r $prefix/pip.list"
		  su $DOAS_USER -c "sh -c 'curl -fLo ${XDG_DATA_HOME:-$HOME/.local/share}/nvim/site/autoload/plug.vim --create-dirs \
			https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim'"
		  su $DOAS_USER -c "nvim +PlugClean! +PlugInstall! +qall!"
		fi
		;;
	*)
		echo "error: unsupported platform ($uname)."
		exit 1
		;;
esac

